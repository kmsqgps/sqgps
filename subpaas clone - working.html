<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Navixy Clone Tool</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 20px;
        }
        .section {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .section h2 {
            margin-top: 0;
            color: #333;
        }
         .section label {
            display: inline-block;
            margin-bottom: 5px;
            font-weight: bold;
         }
         .section input[type="text"],
         .section input[type="number"],
         .section button {
            padding: 8px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
             display: inline-block;
             vertical-align: top;
             margin-right: 10px;
         }
         .section input[type="radio"] {
             margin-right: 5px;
         }

         #adminHashInput {
             width: calc(100% - 150px); /* Adjust width for input */
             min-width: 200px;
         }

         #manualTrackerIds {
            width: 100%;
            height: 100px;
            padding: 8px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            resize: vertical;
         }


        .message-area {
            margin-top: 10px;
            padding: 8px;
            border-radius: 4px;
            min-height: 1em;
            border: 1px solid transparent;
        }
        .message-area.info { color: black; border-color: gray; background-color: #f0f0f0; }
        .message-area.success { color: green; border-color: green; background-color: #e6ffe6;}
        .message-area.error { color: red; border-color: red; background-color: #ffe6e6;}
        .message-area.loading { color: #007bff; border-color: #007bff; background-color: #e6f3ff;}
         .message-area.orange { color: orange; border-color: orange; background-color: #fff2e6;}


        select {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        select[multiple] {
             min-height: 150px;
        }

        /* Hide sections initially or based on JS */
        #adminHashSection,
        #inputMethodSelectionSection,
        #preselectFlowSection,
        #manualInputSection,
         #cloneSection
         {
            display: none;
        }
    </style>
</head>
<body>

    <h1>Navixy Tracker Cloning Tool</h1>

    <div id="serverSelectionSection" class="section">
        <h2>Select Server</h2>
        <label><input type="radio" name="server" value="us"> US Server</label>
        <label><input type="radio" name="server" value="eu"> EU Server</label>
        <div id="serverMessageArea" class="message-area info"></div>
    </div>

    <div id="adminHashSection" class="section">
         <h2>Admin Panel Hash</h2>
         <div>
            <label for="adminHashInput">Enter your Admin Panel Hash:</label><br>
            <input type="password" id="adminHashInput" name="adminHashInput" size="50" placeholder="Enter admin hash here">
         </div>
          <div id="adminHashMessageArea" class="message-area info"></div>
    </div>


    <div id="inputMethodSelectionSection" class="section">
        <h2>Select Tracker Input Method</h2>
        <label><input type="radio" name="inputMethod" value="preselect"> Pre-select from SubPAAS List</label>
        <label><input type="radio" name="inputMethod" value="manual"> Manual Object ID Input</label>
        <div id="inputMethodMessageArea" class="message-area info"></div>
    </div>

    <div id="preselectFlowSection">
        <div id="subpaasListSection" class="section">
            <h2>Available SubPAAS (Select one)</h2>
            <button id="fetchSubpaasListButton">Fetch SubPAAS List</button>
            <div id="subpaasMessageArea" class="message-area info"></div>
            <div id="subpaasListArea">
                </div>
        </div>

        <div id="trackerListSection" class="section">
            <h2>Trackers for Selected SubPAAS (Select one or more to clone)</h2>
            <div id="trackerListArea">
                </div>
             <div id="trackerMessageArea" class="message-area info"></div>
        </div>
    </div>

    <div id="manualInputSection" class="section">
        <h2>Manual Object ID Input</h2>
        <label for="manualTrackerIds">Enter Tracker Object IDs (comma-separated):</label><br>
        <textarea id="manualTrackerIds" placeholder="e.g., 123, 456, 789"></textarea>
        <div id="manualInputMessageArea" class="message-area info"></div>
    </div>


     <div id="cloneSection" class="section">
         <h2>Clone Trackers to User</h2>
         <div>
             <label for="userIdInput">Target User ID:</label>
             <input type="number" id="userIdInput" name="userIdInput" placeholder="Enter User ID">
         </div>
         <button id="cloneButton" disabled>Clone Selected Trackers</button>
         <div id="cloneMessageArea" class="message-area info"></div>
     </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- UI Element References ---
            const serverRadios = document.querySelectorAll('input[name="server"]');
            const inputMethodRadios = document.querySelectorAll('input[name="inputMethod"]');
            const serverSelectionSection = document.getElementById('serverSelectionSection');
            const inputMethodSelectionSection = document.getElementById('inputMethodSelectionSection');
            const adminHashSection = document.getElementById('adminHashSection');
            const adminHashInput = document.getElementById('adminHashInput');
            const serverMessageArea = document.getElementById('serverMessageArea');
            const inputMethodMessageArea = document.getElementById('inputMethodMessageArea');
            const adminHashMessageArea = document.getElementById('adminHashMessageArea');

            const preselectFlowSection = document.getElementById('preselectFlowSection');
            const fetchSubpaasListButton = document.getElementById('fetchSubpaasListButton');
            const subpaasListArea = document.getElementById('subpaasListArea');
            const subpaasMessageArea = document.getElementById('subpaasMessageArea');
            const trackerListArea = document.getElementById('trackerListArea');
            const trackerMessageArea = document.getElementById('trackerMessageArea');

            const manualInputSection = document.getElementById('manualInputSection');
            const manualTrackerIdsTextarea = document.getElementById('manualTrackerIds');

            const cloneSection = document.getElementById('cloneSection');
            const userIdInput = document.getElementById('userIdInput');
            const cloneButton = document.getElementById('cloneButton');
            const cloneMessageArea = document.getElementById('cloneMessageArea');


            // --- State Variables ---
            let baseUrl = '';
            let inputMethod = '';
            let subpaasSelectElement = null;
            let currentSubpaasHash = null;
            let trackerSelectElement = null;


            // --- Helper Functions ---
            function displayMessage(areaElement, message, type = 'info') {
                areaElement.textContent = message;
                areaElement.className = 'message-area';
                areaElement.classList.add(type);
            }

            // Clear content related to input method and cloning
            function clearMethodSpecificContent() {
                subpaasListArea.innerHTML = '';
                trackerListArea.innerHTML = '';
                manualTrackerIdsTextarea.value = '';
                subpaasSelectElement = null;
                trackerSelectElement = null;
                currentSubpaasHash = null; // Clear the SubPAAS hash

                // Hide method specific sections
                preselectFlowSection.style.display = 'none';
                manualInputSection.style.display = 'none';
                cloneSection.style.display = 'none'; // Hide clone section

                displayMessage(subpaasMessageArea, '', 'info');
                displayMessage(trackerMessageArea, '', 'info');
                displayMessage(manualInputMessageArea, '', 'info');
                 displayMessage(cloneMessageArea, '', 'info');
            }

            // Reset the tool back to server selection
            function resetTool() {
                 baseUrl = '';
                 adminHashInput.value = ''; // Clear the hash input itself
                 adminHashSection.style.display = 'none';
                 inputMethodSelectionSection.style.display = 'none';
                 clearMethodSpecificContent(); // This also clears method radios state and subsequent sections

                 // Reset server radios
                 serverRadios.forEach(radio => radio.checked = false);

                 displayMessage(serverMessageArea, 'Select a server to begin.', 'info');
                 displayMessage(adminHashMessageArea, '', 'info');
                 updateCloneButtonState(); // Ensure button is disabled
            }


            // Check if the clone button should be enabled
            function updateCloneButtonState() {
                 const adminHash = adminHashInput.value.trim();
                 const userIdString = userIdInput.value.trim();
                 const userIdIsValid = userIdString !== '' && !isNaN(parseInt(userIdString, 10));

                 let trackersAvailable = false;
                 if (inputMethod === 'preselect') {
                     // Trackers available if the select element exists and has options other than the default
                     trackersAvailable = trackerSelectElement !== null && trackerSelectElement.options.length > 1;
                 } else if (inputMethod === 'manual') {
                     // Trackers available if the manual input has comma-separated values that can be parsed
                     const manualIds = manualTrackerIdsTextarea.value.trim();
                      if (manualIds !== '') {
                          const parsedIds = manualIds.split(',')
                             .map(id => id.trim())
                             .filter(id => id !== '')
                             .map(id => parseInt(id, 10))
                             .filter(id => !isNaN(id));
                          trackersAvailable = parsedIds.length > 0;
                      } else {
                          trackersAvailable = false;
                      }
                 }

                 // Button is enabled if base URL, admin hash, input method selected, user ID is valid, and trackers are available
                 cloneButton.disabled = !(baseUrl && adminHash && inputMethod && userIdIsValid && trackersAvailable);

                 // Show clone section once method is chosen and admin hash is present
                 if (inputMethod && adminHash) {
                     cloneSection.style.display = 'block';
                 } else {
                     cloneSection.style.display = 'none';
                 }
            }


            // --- Event Listeners ---

            // Server Selection Change
            serverRadios.forEach(radio => {
                radio.addEventListener('change', () => {
                    baseUrl = `https://api.${radio.value}.navixy.com/v2`;
                    displayMessage(serverMessageArea, `Server set to ${radio.value.toUpperCase()}.`, 'success');

                    // Show the Admin Hash section
                    adminHashSection.style.display = 'block';

                    // Clear subsequent sections and state (including admin hash input value)
                    adminHashInput.value = ''; // Clear the hash input itself for a clean start on this step
                    clearMethodSpecificContent(); // This also clears input method radios state and below
                    inputMethodSelectionSection.style.display = 'none'; // Explicitly hide input method selection initially

                     // Manually ensure input method radios are unchecked when hash section appears
                     inputMethodRadios.forEach(methodRadio => methodRadio.checked = false);
                     inputMethod = ''; // Ensure state is also reset


                    updateCloneButtonState(); // Update button state
                });
            });

            // Admin Hash Input Change (auto-proceed)
            adminHashInput.addEventListener('input', () => {
                 const adminHash = adminHashInput.value.trim();

                 // Clear input method specific sections and state when hash changes
                 clearMethodSpecificContent(); // This clears content areas and hides method/clone sections
                 inputMethodSelectionSection.style.display = 'none'; // Explicitly hide input method selection temporarily

                 if (adminHash) {
                     displayMessage(adminHashMessageArea, 'Admin Hash entered.', 'success');
                     inputMethodSelectionSection.style.display = 'block'; // Show input method selection

                     // Manually ensure input method radios are unchecked when they appear
                     inputMethodRadios.forEach(methodRadio => methodRadio.checked = false);
                      inputMethod = ''; // Ensure state is also reset

                     updateCloneButtonState(); // Update button state
                 } else {
                     displayMessage(adminHashMessageArea, 'Please enter Admin Hash.', 'info');
                      // If hash is cleared, hide input method section again
                      inputMethodSelectionSection.style.display = 'none';
                      // Also hide clone section explicitly if hash becomes empty
                      cloneSection.style.display = 'none';
                     updateCloneButtonState();
                 }
            });


            // Input Method Selection Change
            inputMethodRadios.forEach(radio => {
                radio.addEventListener('change', () => {
                    // This listener only fires *after* the browser successfully changes the radio state
                    inputMethod = radio.value;
                    // Do NOT call clearMethodSpecificContent() here, it would clear the method selection itself!
                    // Instead, manually hide/clear the parts specific to the *other* method.

                    // Hide/clear content of the OTHER method's section
                     if (inputMethod === 'preselect') {
                         manualInputSection.style.display = 'none';
                         manualTrackerIdsTextarea.value = ''; // Clear manual input
                         displayMessage(manualInputMessageArea, '', 'info');
                     } else if (inputMethod === 'manual') {
                         preselectFlowSection.style.display = 'none';
                         // Clear preselect-specific elements and state
                         subpaasListArea.innerHTML = '';
                         trackerListArea.innerHTML = '';
                         subpaasSelectElement = null;
                         trackerSelectElement = null;
                         currentSubpaasHash = null; // Clear subpaas hash state
                         displayMessage(subpaasMessageArea, '', 'info');
                         displayMessage(trackerMessageArea, '', 'info');
                     }


                    if (inputMethod === 'preselect') {
                        preselectFlowSection.style.display = 'block';
                        displayMessage(inputMethodMessageArea, 'Using pre-select method. Click "Fetch SubPAAS List".', 'info');
                         fetchSubpaasListButton.style.display = 'inline-block';
                    } else if (inputMethod === 'manual') {
                        manualInputSection.style.display = 'block';
                        displayMessage(inputMethodMessageArea, 'Using manual input method. Enter Object IDs and Target User ID.', 'info');
                         fetchSubpaasListButton.style.display = 'none';
                    }
                     updateCloneButtonState(); // Update button state now that method is selected and section is visible
                });
            });

             // Listen for changes in User ID and Manual Input to potentially enable clone button
             userIdInput.addEventListener('input', updateCloneButtonState);
             manualTrackerIdsTextarea.addEventListener('input', updateCloneButtonState);


            // --- Step 1: Fetch SubPAAS List (only in preselect flow) ---
            fetchSubpaasListButton.addEventListener('click', async () => {
                const adminHash = adminHashInput.value.trim();

                // Clear dynamic content within the preselect flow areas
                 subpaasListArea.innerHTML = '';
                 trackerListArea.innerHTML = '';
                 subpaasSelectElement = null;
                 trackerSelectElement = null;
                 currentSubpaasHash = null;
                 cloneButton.disabled = true; // Disable clone button

                 displayMessage(subpaasMessageArea, '', 'info');
                 displayMessage(trackerMessageArea, '', 'info');
                 displayMessage(cloneMessageArea, '', 'info');


                if (!baseUrl) {
                    displayMessage(serverMessageArea, 'Server selection was lost. Please select a server.', 'orange');
                    resetTool();
                    return;
                }

                if (!adminHash) {
                    displayMessage(adminHashMessageArea, 'Admin Hash is missing. Please enter it.', 'error');
                    // If admin hash is somehow lost here, reset the whole flow
                    resetTool(); // Maybe too harsh? Or just clear method-specific and hash input
                    // Let's just ensure subsequent steps are blocked.
                    clearMethodSpecificContent(); // This will hide the preselect section
                     displayMessage(adminHashMessageArea, 'Admin Hash is missing.', 'error'); // Re-display hash error
                    return;
                }

                displayMessage(subpaasMessageArea, 'Loading SubPAAS list...', 'loading');

                const subpaasListApiUrl = `${baseUrl}/panel/subpaas/list`;

                try {
                    const response = await fetch(subpaasListApiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ hash: adminHash }) // Use Admin Hash
                    });

                    if (!response.ok) {
                        let errorDetails = `HTTP error fetching SubPAAS list! Status: ${response.status}`;
                         try {
                             const errorData = await response.json();
                              if (errorData && errorData.error) {
                                 errorDetails += ` - API Error: ${errorData.error.message || errorData.error}`;
                              } else {
                                errorDetails += ` - Response: ${JSON.stringify(errorData)}`;
                              }
                         } catch (jsonError) { /* ignore */ }
                        throw new Error(errorDetails);
                    }

                    const data = await response.json();

                    // ASSUMPTION: Successful SubPAAS list response is a JSON object with a 'list' array property
                    if (data && Array.isArray(data.list)) {
                        if (data.list.length > 0) {
                            subpaasSelectElement = document.createElement('select');
                            subpaasSelectElement.id = 'subpaasSelect';
                            subpaasSelectElement.setAttribute('size', data.list.length > 10 ? 10 : data.list.length + 1);


                            const defaultOption = document.createElement('option');
                            defaultOption.value = "";
                            defaultOption.textContent = "-- Select a SubPAAS --";
                            defaultOption.disabled = true;
                            defaultOption.selected = true;
                            subpaasSelectElement.appendChild(defaultOption);

                            data.list.forEach(subpaas => {
                                const option = document.createElement('option');
                                option.value = subpaas.subpaas_id;
                                option.textContent = `ID: ${subpaas.subpaas_id}, Name: ${subpaas.name || subpaas.title || 'N/A'}`;
                                subpaasSelectElement.appendChild(option);
                            });

                            subpaasListArea.appendChild(subpaasSelectElement);
                            displayMessage(subpaasMessageArea, `Found ${data.list.length} SubPAAS. Please select one.`, 'success');

                             // Add Event Listener to the SubPAAS Select (only after creating it)
                             subpaasSelectElement.addEventListener('change', handleSubpaasSelection);

                        } else {
                            subpaasListArea.textContent = 'No SubPAAS found for this hash.';
                            subpaasSelectElement = null;
                             displayMessage(subpaasMessageArea, 'No SubPAAS found for this hash.', 'info');
                        }
                    } else if (data && data.error) {
                         displayMessage(subpaasMessageArea, `API returned an error fetching SubPAAS list: ${data.error.message || data.error}`, 'error');
                         console.error('Navixy API Error (SubPAAS List):', data.error);
                         subpaasSelectElement = null;
                    }
                    else {
                        console.error('Unexpected SubPAAS List API response structure:', data);
                        displayMessage(subpaasMessageArea, `Received SubPAAS list data, but structure was unexpected. Check console.`, 'error');
                        subpaasSelectElement = null;
                    }

                } catch (error) {
                    console.error('Fetch SubPAAS list error:', error);
                    displayMessage(subpaasMessageArea, `Error fetching SubPAAS list: ${error.message}`, 'error');
                     subpaasSelectElement = null;
                }
            });

            // --- Step 2: Create SubPAAS Session & Step 3: Fetch Trackers (only in preselect flow) ---
            async function handleSubpaasSelection() {
                const selectedSubpaasId = this.value;
                const adminHash = adminHashInput.value.trim();

                // Clear previous tracker list/messages and disable clone button
                trackerListArea.innerHTML = '';
                trackerSelectElement = null;
                currentSubpaasHash = null;
                cloneButton.disabled = true;
                displayMessage(trackerMessageArea, '', 'info');
                displayMessage(cloneMessageArea, '', 'info');

                 if (!baseUrl) {
                    displayMessage(serverMessageArea, 'Server selection was lost. Please select a server.', 'orange');
                    resetTool();
                    return;
                 }

                 if (!adminHash) {
                    displayMessage(adminHashMessageArea, 'Admin Hash is missing. Cannot create session.', 'error');
                     clearMethodSpecificContent();
                    return;
                 }


                if (!selectedSubpaasId) {
                     // This is the default "Select a SubPAAS" option
                     displayMessage(subpaasMessageArea, 'Select a SubPAAS to create session and load trackers.', 'info');
                    return;
                }

                displayMessage(subpaasMessageArea, `Creating session for SubPAAS ID ${selectedSubpaasId}...`, 'loading');

                const sessionCreateApiUrl = `${baseUrl}/panel/subpaas/session/create`;

                try {
                    const response = await fetch(sessionCreateApiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            hash: adminHash, // Use the ADMIN hash
                            subpaas_id: parseInt(selectedSubpaasId, 10)
                        })
                    });

                    if (!response.ok) {
                        let errorDetails = `HTTP error creating SubPAAS session! Status: ${response.status}`;
                         try {
                             const errorData = await response.json();
                              if (errorData && errorData.error) {
                                 errorDetails += ` - API Error: ${errorData.error.message || errorData.error}`;
                              } else {
                                errorDetails += ` - Response: ${JSON.stringify(errorData)}`;
                              }
                         } catch (jsonError) { /* ignore */ }
                        throw new Error(errorDetails);
                    }

                    const data = await response.json();

                    // ASSUMPTION: Successful session create returns a JSON object with the new hash in a property (e.g., 'hash')
                    if (data && data.hash) {
                         currentSubpaasHash = data.hash; // Store the obtained subpaas hash
                         displayMessage(trackerMessageArea, `Session created for SubPAAS ID ${selectedSubpaasId}. Now loading trackers...`, 'success');

                         // --- Now proceed to Step 3: Fetch Trackers using the new subpaas hash ---
                         fetchTrackers(currentSubpaasHash); // Call the next step

                    } else if (data && data.error) {
                        displayMessage(trackerMessageArea, `API returned an error creating session: ${data.error.message || data.error}`, 'error');
                        console.error('Navixy API Error (Session Create):', data.error);
                    }
                    else {
                        console.error('Unexpected Session Create API response structure:', data);
                        displayMessage(trackerMessageArea, `Received session data, but hash property was not found. Check console.`, 'error');
                    }

                } catch (error) {
                    console.error('Fetch Session Create error:', error);
                    displayMessage(trackerMessageArea, `Error creating SubPAAS session: ${error.message}`, 'error');
                     trackerListArea.innerHTML = '';
                     trackerSelectElement = null;
                     cloneButton.disabled = true;
                     displayMessage(trackerMessageArea, '', 'info');
                }
            }

            // --- Step 3: Fetch Trackers using SubPAAS Hash (only in preselect flow) ---
            async function fetchTrackers(subpaasHash) {
                trackerListArea.innerHTML = '';
                trackerSelectElement = null;
                 cloneButton.disabled = true;

                displayMessage(trackerMessageArea, `Loading trackers using SubPAAS hash...`, 'loading');

                 if (!baseUrl) {
                    displayMessage(serverMessageArea, 'Server selection was lost. Please select a server.', 'orange');
                     displayMessage(trackerMessageArea, 'Cannot fetch trackers: Server not selected.', 'error');
                     resetTool();
                    return;
                 }

                if (!subpaasHash) {
                    displayMessage(trackerMessageArea, 'SubPAAS hash is missing. Session creation might have failed.', 'error');
                    return;
                }

                const trackerApiUrl = `${baseUrl}/panel/tracker/list`;

                try {
                    const response = await fetch(trackerApiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ hash: subpaasHash }) // Use the SUBPAAS HASH here
                    });

                    if (!response.ok) {
                         let errorDetails = `HTTP error fetching trackers! Status: ${response.status}`;
                         try {
                             const errorData = await response.json();
                              if (errorData && errorData.error) {
                                 errorDetails += ` - API Error: ${errorData.error.message || errorData.error}`;
                              } else {
                                 // If response is not JSON, just show the status
                                 // errorDetails += ` - Response: ${await response.text()}`; // Can get raw text if needed
                              }
                         } catch (jsonError) { /* ignore */ }
                        throw new Error(errorDetails);
                    }

                    const data = await response.json();

                    // ASSUMPTION: Successful Tracker response is JSON with a 'list' array property
                    if (data && Array.isArray(data.list)) {
                        if (data.list.length > 0) {
                            trackerSelectElement = document.createElement('select');
                            trackerSelectElement.setAttribute('multiple', 'multiple');
                            trackerSelectElement.setAttribute('size', data.list.length > 15 ? 15 : data.list.length + 1);

                            data.list.forEach(tracker => {
                                const option = document.createElement('option');
                                // ASSUMPTION: Tracker object has 'id' and 'name' properties
                                option.value = tracker.id;
                                option.textContent = `ID: ${tracker.id}, Name: ${tracker.label || 'N/A'}`;
                                trackerSelectElement.appendChild(option);
                            });

                            trackerListArea.appendChild(trackerSelectElement);
                            displayMessage(trackerMessageArea, `Found ${data.list.length} tracker(s) for this SubPAAS.`, 'success');

                             // Add input listener to the select element to check if any items are selected
                             trackerSelectElement.addEventListener('change', updateCloneButtonState);

                             updateCloneButtonState(); // Update button state now that trackers are loaded


                        } else {
                            trackerListArea.textContent = 'No trackers found for this SubPAAS hash.';
                            displayMessage(trackerMessageArea, 'No trackers found for this SubPAAS hash.', 'info');
                             trackerSelectElement = null;
                             updateCloneButtonState(); // Update button state
                        }
                    } else if (data && data.error) {
                         displayMessage(trackerMessageArea, `API returned an error fetching trackers: ${data.error.message || data.error}`, 'error');
                         console.error('Navixy API Error (Trackers):', data.error);
                         trackerSelectElement = null;
                         updateCloneButtonState();
                    }
                    else {
                         console.error('Unexpected Tracker API response structure:', data);
                         displayMessage(trackerMessageArea, `Received tracker data, but structure was unexpected. Check console.`, 'orange');
                         trackerSelectElement = null;
                         updateCloneButtonState();
                    }

                } catch (error) {
                    console.error('Fetch tracker error:', error);
                    displayMessage(trackerMessageArea, `Error fetching tracker data: ${error.message}`, 'error');
                    trackerListArea.innerHTML = '';
                    trackerSelectElement = null;
                    updateCloneButtonState();
                }
            }

            // --- Step 4: Clone Selected Trackers ---
            cloneButton.addEventListener('click', async () => {
                const adminHash = adminHashInput.value.trim(); // Use the ORIGINAL admin hash
                const userIdString = userIdInput.value.trim();
                const userId = parseInt(userIdString, 10);

                displayMessage(cloneMessageArea, '', 'info');

                 if (!baseUrl) {
                     displayMessage(cloneMessageArea, 'Server not selected.', 'error');
                     return;
                 }

                if (!adminHash) {
                    displayMessage(cloneMessageArea, 'Admin Hash is missing. Cannot perform clone.', 'error');
                    return;
                }

                 if (isNaN(userId) || userIdString === '') {
                     displayMessage(cloneMessageArea, 'Please enter a valid Target User ID.', 'orange');
                     userIdInput.focus();
                     return;
                 }

                let selectedTrackerIds = [];

                if (inputMethod === 'preselect') {
                    if (!trackerSelectElement) {
                         displayMessage(cloneMessageArea, 'Tracker list not loaded in pre-select mode.', 'error');
                         return;
                    }
                    for (const option of trackerSelectElement.options) {
                        if (option.selected) {
                             const trackerId = parseInt(option.value, 10);
                             if (!isNaN(trackerId)) {
                                 selectedTrackerIds.push(trackerId);
                             } else {
                                 console.warn(`Skipping invalid selected tracker ID value: ${option.value}`);
                             }
                        }
                    }
                } else if (inputMethod === 'manual') {
                    const manualIdsString = manualTrackerIdsTextarea.value.trim();
                    if (!manualIdsString) {
                         displayMessage(cloneMessageArea, 'Please enter tracker Object IDs in the manual input box.', 'orange');
                         manualTrackerIdsTextarea.focus();
                         return;
                    }
                    selectedTrackerIds = manualIdsString
                        .split(',')
                        .map(id => id.trim())
                        .filter(id => id !== '')
                        .map(id => parseInt(id, 10))
                        .filter(id => !isNaN(id));

                    if (selectedTrackerIds.length === 0) {
                         displayMessage(cloneMessageArea, 'No valid tracker Object IDs found in manual input. Ensure they are comma-separated numbers.', 'orange');
                         manualTrackerIdsTextarea.focus();
                         return;
                    }

                } else {
                     displayMessage(cloneMessageArea, 'Input method not selected.', 'error');
                     return;
                }


                if (selectedTrackerIds.length === 0) {
                    displayMessage(cloneMessageArea, 'No trackers selected or entered to clone.', 'orange');
                    return;
                }

                displayMessage(cloneMessageArea, `Cloning ${selectedTrackerIds.length} tracker(s) to User ID ${userId}...`, 'loading');

                const cloneApiUrl = `${baseUrl}/panel/tracker/batch_clone`;

                try {
                    const response = await fetch(cloneApiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            hash: adminHash, // Use the ADMIN hash for cloning
                            user_id: userId,
                            tracker_ids: selectedTrackerIds,
                            ignore_existing: true
                        })
                    });

                     if (!response.ok) {
                         let errorDetails = `HTTP error during cloning! Status: ${response.status}`;
                         try {
                             const errorData = await response.json();
                              if (errorData && errorData.error) {
                                 errorDetails += ` - API Error: ${errorData.error.message || errorData.error}`;
                              } else {
                                // If response is not JSON, just show the status
                                // errorDetails += ` - Response: ${await response.text()}`; // Can get raw text if needed
                              }
                         } catch (jsonError) { /* ignore */ }
                         throw new Error(errorDetails);
                     }

                    const data = await response.json();

                    // ASSUMPTION: Successful batch_clone might return a success status or details.
                    if (data && data.success) {
                         displayMessage(cloneMessageArea, `Successfully cloned ${selectedTrackerIds.length} tracker(s) to User ID ${userId}.`, 'success');
                         console.log('Batch Clone Success:', data);
                         // Optional: Clear user ID and manual input after successful clone
                         // userIdInput.value = '';
                         // manualTrackerIdsTextarea.value = '';
                         // updateCloneButtonState(); // Update button state
                     } else if (data && data.error) {
                        displayMessage(cloneMessageArea, `API Error during cloning: ${data.error.message || data.error}`, 'error');
                        console.error('Navixy API Clone Error:', data.error);
                     }
                     else {
                         console.error('Unexpected successful clone API response structure:', data);
                         displayMessage(cloneMessageArea, `Cloning request sent, but response structure was unexpected. Check console.`, 'orange');
                     }


                } catch (error) {
                    console.error('Clone fetch error:', error);
                    displayMessage(cloneMessageArea, `Error during cloning: ${error.message}`, 'error');
                }
            });

             // --- Initial Setup ---
             resetTool();


        });
    </script>

</body>
</html>
